<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script>
	function OKbtn() {
		var i=$('#in').val();
		try {
			var j=JSON.parse(i);

			var o=`
<html>
  <head>
    <title>`+j.name+`</title>
  </head>
  <body>
    <pre id="output"></pre>
    <div id="storyData" style="display: none;">
      <tw-storydata name="`+j.name+`" startnode="`+j.startnode+`" creator="`+j.creator+`" creator-version="`+j['creator-version']+`" ifid="`+j.ifid+`" zoom="1" format="Twison" format-version="0.0.1" options="" hidden>
`;
			
			j.passages.map(p => {
				tags = "";
				if(p.tags) p.tags.map(t => { tags += t + " "; });
				
				text = p.text;
				text = text.replace(/\[\[[^\]]*\]\]/g, (t, g) => {
					if(!g) return t;
					else {
						s = t.split("->");
						r = s[0].replace(/\n/g, "&lt;br/&gt;");
						if(s.length==2) r += "->" + s[1].replace(/\n/g, "\\n").replace(/"/g,"");
						return r;
					}
				});
				
				o += `        <tw-passagedata pid="`+p.pid+`" name="`+p.name.replace(/\n/g,"\\n").replace(/"/g,"")+`" tags="`+tags.trim()+`" position="`+p.position.x+`,`+p.position.y+`" size="100,100">`+text+`</tw-passagedata>\n`;
			});

			o += `
      </tw-storydata>
    </div>
  </body>
</html>
`;

			$('#out').val(o.trim());
		} catch(err) { alert(err); }
	}
	
	function upload() {
		const file = event.target.files[0];
		const reader = new FileReader();
		reader.addEventListener('load', event => {
			$('#in').val(event.target.result);
		});
		reader.readAsText(file);
	}
	
	function download() {
		var blob = new Blob([$("#out").val().replace(/\n/g,"\r\n")], {type: 'text/html'});
		var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = "downloaded.html";        
        document.body.appendChild(elem);
        elem.click();        
        document.body.removeChild(elem);
	}
</script>

<style>
	body { text-align:center; font-family:sans-serif }
	input, button { width:100% }
	textarea { width:100%; height:150px; border: 1px solid grey }
</style>

<title>JSwine</title>

<h2>JSwine</h2>
Mengkonversi berkas JSON naskah novel visual berbasis Twine kembali ke proyek yang dapat diubah<br>
<i>Convert Twine based visual novel script JSON file back into an editable project</i><br>

<h3>Input</h3>
<input type=button value="Unggah / Upload" onclick="$('#file').click()"/>
<input type="file" id="file" style="display:none" onchange="upload()">
<textarea id="in">
{
  "passages": [
    {
      "text": "Double-click this passage to edit it.\n\n[[A]]\n[[B]]",
      "links": [
        {
          "name": "A",
          "link": "A",
          "pid": "2"
        },
        {
          "name": "B",
          "link": "B",
          "pid": "3"
        }
      ],
      "name": "Untitled Passage",
      "pid": "1",
      "position": {
        "x": "700",
        "y": "299"
      }
    },
    {
      "text": "Double-click this passage to edit it.",
      "name": "A",
      "pid": "2",
      "position": {
        "x": "625",
        "y": "449"
      }
    },
    {
      "text": "Double-click this passage to edit it.",
      "name": "B",
      "pid": "3",
      "position": {
        "x": "775",
        "y": "449"
      }
    }
  ],
  "name": "a",
  "startnode": "1",
  "creator": "Twine",
  "creator-version": "2.3.8",
  "ifid": "E7320DDA-FEE0-4038-B4CC-515F97BAD6E3"
}
</textarea>
<input type=button value="Konversi / Convert" onclick="OKbtn()"/><br><br>

<h3>Output</h3>
<textarea id="out"></textarea>
<input type=button value="Unduh / Download" onclick="download()"/>

<br><br>&copy; 2020 William Surya Permana
